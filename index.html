<!DOCTYPE html>
<html lang="he">
<head>
  <meta charset="UTF-8" />
  <title>Voice + OpenAI Test</title>
  <style>
    body { font-family: Arial; padding: 2em; text-align: center; }
    #mic { font-size: 2em; cursor: pointer; }
    #result { margin-top: 2em; white-space: pre-line; direction: rtl; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/eruda"></script>
</head>
<body>
  <h1>הפעלת הוראות קוליות</h1>
  <div id="mic">🎤</div>
  <div id="result">המתן לתשובה...</div>
   <div id="result1"></div>
  

<script>eruda.init();</script>
<script>
const SYSTEM_PROMPT = `
אתה מערכת שמזהה כוונות של משתמשים ומחזירה תגובה מובנית בפורמט JSON.
להלן הכללים:
- אם המשתמש מתכוון לעבור למחשבונים פיננסיים, החזר {"target": 1}
- להשוואת חברות {"target": 2}
- למידע מקצועי {"target": 3}
- לקרנות פנסיה {"target": 4}
- לגמל להשקעה {"target": 5}
- לקרנות השתלמות {"target": 6}
- לחיסכון לילד {"target": 7}
- לקופות גמל {"target": 8}
- לפוליסות חיסכון {"target": 9}
- אם מדובר על הלוואות – בדוק אם נמסרו סכום, תקופה, ריבית
- אם מדובר בערך עתידי – בדוק אם נמסרו סכום, הפקדה חודשית, ריבית ותקופה
- אם מדובר בהשוואת חברות – בדוק אם נמסרו שמות החברות: הראל, מנורה, מגדל, כלל, הפניקס, ילין לפידות, אלטשולר שחם, אנליסט, מור, מיטב
- אם מדובר בהשוואת מסלולים – חובה לזהות: חברה, מוצר, מסלול. מוצרים אפשריים: קרן השתלמות, קופת גמל, קרן פנסיה, חיסכון לילד, גמל להשקעה, פוליסת חיסכון
- אם חסר מידע קריטי – החזר גם {"missing": "ריבית"} או {"missing": ["ריבית", "תקופה"]}
- החזר תמיד בפורמט JSON תקין בלבד
`;

const recognition = new webkitSpeechRecognition() || new SpeechRecognition();
recognition.lang = "he-IL";
recognition.continuous = false;
recognition.interimResults = false;

document.getElementById("mic").onclick = () => {
  console.log("האזנה התחילה");
  recognition.start();
};

recognition.onresult = async (event) => {
  const transcript = event.results[0][0].transcript;
  console.log("קלט מהמשתמש:", transcript);
  document.getElementById("result1").textContent = "המשתמש אמר: " + transcript + "\nממתין לתשובת OpenAI...";
  const response = await sendToOpenAI(transcript);
  document.getElementById("result").textContent = "תשובת OpenAI:\n" + response;
};

recognition.onerror = (e) => {
  console.error("שגיאת זיהוי קולי:", e.error);
  document.getElementById("result").textContent = "שגיאה בזיהוי קולי: " + e.error;
};

async function sendToOpenAI(userInput) {
  try {
    const res = await fetch("https://financinet-95f193c98057.herokuapp.com/api/openai", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        // אפשר לשלב כאן גם את המפתח אם יש צורך בהעברתו מהלקוח,
        // אבל עדיף לעבוד עם משתני סביבה (כמו שעשינו ב־Heroku).
      },
      body: JSON.stringify({ text: userInput })
    });

    if (!res.ok) {
      const errorText = await res.text();
      return `שגיאה מהשרת: ${res.status}\n${errorText}`;
    }

    const data = await res.json();
    return data.answer;
  } catch (err) {
    return "שגיאה כללית: " + err.message;
  }
}
</script>
</body>
</html>
